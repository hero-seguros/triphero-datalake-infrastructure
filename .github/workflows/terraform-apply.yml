name: Terraform Apply

on:
  pull_request:
    types: [labeled]
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read

jobs:
  terraform-apply:
    name: Terraform Apply
    if: github.event.label.name == 'terraform:apply'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2
      
      - name: Download Plan Artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: terraform-plan.yml
          name: terraform-plan-prod-pr-${{ github.event.pull_request.number }}
          path: .
          pr: ${{ github.event.pull_request.number }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Terraform Init
        run: terraform init
      
      - name: Terraform Apply
        id: apply
        run: |
          terraform apply -auto-approve tfplan 2>&1 | tee apply-output.txt
          echo "exitcode=$?" >> $GITHUB_OUTPUT
      
      - name: Save Apply Output as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-apply-prod-${{ github.sha }}
          path: apply-output.txt
          retention-days: 90
      
      - name: Create Apply Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<'EOF'
          ## âœ… Terraform Apply Completed - Datalake
          
          **Environment:** Production
          **Branch:** `${{ github.head_ref }}`
          **Commit:** `${{ github.sha }}`
          **Status:** ${{ steps.apply.outcome == 'success' && 'âœ… Success' || 'âŒ Failed' }}
          
          ### ğŸ“¦ Apply Output
          
          <details>
          <summary>Click to expand</summary>
          
          \`\`\`
          $(cat apply-output.txt | tail -100)
          \`\`\`
          
          </details>
          
          ### ğŸ¯ Next Steps
          
          - âœ… VPC Peering is being established (~5 minutes)
          - âœ… MSK cluster is being created (~15 minutes)
          - âš™ï¸ Check MSK status:
          ```bash
          aws kafka list-clusters --region us-east-2
          ```
          - ğŸ“Š Get bootstrap brokers:
          ```bash
          aws kafka get-bootstrap-brokers --cluster-arn <CLUSTER_ARN> --region us-east-2
          ```
          - PR will be merged automatically
          
          ---
          
          ğŸ“¦ **Artifact:** `terraform-apply-prod-${{ github.sha }}`
          EOF
      
      - name: Comment PR with Apply Result
        uses: actions/github-script@v7
        with:
          script: |
            const output = `## âœ… Terraform Apply Completed - Datalake
            
            **Status:** ${{ steps.apply.outcome == 'success' && 'âœ… Success' || 'âŒ Failed' }}
            
            VPC Peering and MSK cluster are being created. This process takes approximately **15 minutes**.
            
            ### Infrastructure Created:
            - âœ… VPC Peering (sa-east-1 â†” us-east-2)
            - âœ… MSK Cluster (2x kafka.t3.small)
            - âœ… IAM Roles (Debezium IRSA)
            
            ğŸ“¦ Download apply artifact for details
            
            ---
            
            ğŸ”„ Attempting auto-merge...
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
      
      - name: Auto Merge PR
        if: steps.apply.outcome == 'success'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                merge_method: 'squash',
                commit_title: 'ğŸš€ Apply Terraform changes - Datalake',
                commit_message: 'Automatically merged after successful terraform apply'
              });
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: 'âœ… PR merged automatically!'
              });
            } catch (error) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `âš ï¸ Auto-merge failed: ${error.message}\n\nPlease merge manually.`
              });
            }
      
      - name: Terraform Destroy on Failure
        if: steps.apply.outcome == 'failure'
        run: |
          echo "âš ï¸ Apply failed! Running terraform destroy to cleanup..."
          # Target destroy MSK cluster first (it uses the configuration)
          terraform destroy -target=aws_msk_cluster.main -auto-approve -var-file=environments/prod.tfvars 2>&1 | tee destroy-output.txt
          echo "" >> destroy-output.txt
          echo "=== Destroying remaining resources ===" >> destroy-output.txt
          # Then destroy everything else
          terraform destroy -auto-approve -var-file=environments/prod.tfvars 2>&1 | tee -a destroy-output.txt
      
      - name: Save Destroy Output
        if: steps.apply.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-destroy-prod-${{ github.sha }}
          path: destroy-output.txt
          retention-days: 90
      
      - name: Apply Failed - Add Label and Comment
        if: steps.apply.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['terraform:apply-failed']
            });
            
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'terraform:apply'
            });
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âŒ Terraform Apply Failed\n\n**Action Taken:** Ran \`terraform destroy\` to cleanup partial resources\n\n### Next Steps:\n1. Review the apply error in artifacts\n2. Fix the issue in code\n3. Push new commit\n4. Re-add label \`terraform:apply\` to retry\n\nğŸ“¦ **Destroy artifact:** \`terraform-destroy-prod-${{ github.sha }}\``
            });
