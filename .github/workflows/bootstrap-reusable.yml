name: Bootstrap Check & Create

on:
  workflow_call:
    inputs:
      aws_region:
        description: 'AWS Region'
        required: true
        type: string
        default: 'us-east-2'
      project_name:
        description: 'Project name for bucket naming'
        required: true
        type: string
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
    outputs:
      bootstrap_exists:
        description: 'Whether bootstrap was already created'
        value: ${{ jobs.check-bootstrap.outputs.exists }}
      state_bucket:
        description: 'Name of the state bucket'
        value: ${{ jobs.check-bootstrap.outputs.bucket_name }}

jobs:
  check-bootstrap:
    name: Check if Bootstrap Exists
    runs-on: ubuntu-latest
    outputs:
      exists: ${{ steps.check.outputs.exists }}
      bucket_name: ${{ steps.check.outputs.bucket_name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ inputs.aws_region }}
      
      - name: Check if S3 Bucket Exists
        id: check
        run: |
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          BUCKET_NAME="${{ inputs.project_name }}-terraform-state-${AWS_ACCOUNT_ID}"
          echo "bucket_name=$BUCKET_NAME" >> $GITHUB_OUTPUT
          
          if aws s3 ls "s3://$BUCKET_NAME" 2>/dev/null; then
            echo "✅ Bootstrap bucket exists: $BUCKET_NAME"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "⚠️  Bootstrap bucket NOT found: $BUCKET_NAME"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Check if DynamoDB Table Exists
        if: steps.check.outputs.exists == 'true'
        run: |
          TABLE_NAME="${{ inputs.project_name }}-terraform-lock"
          
          if aws dynamodb describe-table --table-name "$TABLE_NAME" 2>/dev/null; then
            echo "✅ DynamoDB lock table exists: $TABLE_NAME"
          else
            echo "❌ DynamoDB table NOT found but bucket exists!"
            echo "This is inconsistent - manual intervention may be needed"
            exit 1
          fi

  create-bootstrap:
    name: Create Bootstrap Resources
    runs-on: ubuntu-latest
    needs: check-bootstrap
    if: needs.check-bootstrap.outputs.exists == 'false'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ inputs.aws_region }}
      
      - name: Create S3 Bucket
        run: |
          BUCKET_NAME="${{ needs.check-bootstrap.outputs.bucket_name }}"
          
          aws s3api create-bucket \
            --bucket "$BUCKET_NAME" \
            --region ${{ inputs.aws_region }} \
            --create-bucket-configuration LocationConstraint=${{ inputs.aws_region }}
          
          aws s3api put-bucket-versioning \
            --bucket "$BUCKET_NAME" \
            --versioning-configuration Status=Enabled
          
          aws s3api put-bucket-encryption \
            --bucket "$BUCKET_NAME" \
            --server-side-encryption-configuration '{
              "Rules": [{
                "ApplyServerSideEncryptionByDefault": {
                  "SSEAlgorithm": "AES256"
                }
              }]
            }'
          
          aws s3api put-public-access-block \
            --bucket "$BUCKET_NAME" \
            --public-access-block-configuration \
              "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"
          
          echo "✅ S3 bucket created: $BUCKET_NAME"
      
      - name: Create DynamoDB Table
        run: |
          TABLE_NAME="${{ inputs.project_name }}-terraform-lock"
          
          aws dynamodb create-table \
            --table-name "$TABLE_NAME" \
            --attribute-definitions AttributeName=LockID,AttributeType=S \
            --key-schema AttributeName=LockID,KeyType=HASH \
            --billing-mode PAY_PER_REQUEST \
            --region ${{ inputs.aws_region }} \
            --tags Key=Project,Value=hero-trip Key=Environment,Value=prod Key=ManagedBy,Value=Terraform
          
          aws dynamodb wait table-exists --table-name "$TABLE_NAME" --region ${{ inputs.aws_region }}
          
          echo "✅ DynamoDB table created: $TABLE_NAME"
